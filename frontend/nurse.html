<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>护士工作站 - 智能监护系统</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #334155;
        }
        .patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .patient-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #334155;
            transition: all 0.3s;
        }
        .patient-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .patient-card.critical {
            border-color: #ef4444;
            background: #7f1d1d;
        }
        .patient-card.high {
            border-color: #f59e0b;
            background: #7c2d12;
        }
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .patient-name {
            font-size: 18px;
            font-weight: 600;
        }
        .alert-count {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .alert-panel {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        .alert-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .alert-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1>护士工作站</h1>
                <p style="color: #94a3b8; margin-top: 4px;">智能监护系统监控大屏</p>
            </div>
            <div>
                <span class="status-indicator normal" id="wsStatus"></span>
                <span id="wsStatusText">已连接</span>
            </div>
        </div>
        
        <!-- 患者监控大屏 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">患者监控</h2>
                <button class="btn btn-primary" onclick="refreshPatients()">刷新</button>
            </div>
            <div id="patientsGrid" class="patient-grid"></div>
        </div>
        
        <!-- 告警中心 -->
        <div class="alert-panel">
            <div class="card-header">
                <h2 class="card-title">告警中心</h2>
            </div>
            <div class="alert-filters">
                <button class="filter-btn active" onclick="filterAlerts('all')">全部</button>
                <button class="filter-btn" onclick="filterAlerts('pending')">待处理</button>
                <button class="filter-btn" onclick="filterAlerts('critical')">紧急</button>
                <button class="filter-btn" onclick="filterAlerts('high')">高优先级</button>
            </div>
            <div id="alertsList"></div>
        </div>
    </div>
    
    <!-- 告警处理模态框 -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 16px;">处理告警</h2>
            <div id="alertModalContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="acknowledgeAlert()">确认</button>
                <button class="btn btn-success" onclick="resolveAlert()">处理完成</button>
            </div>
        </div>
    </div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/websocket.js"></script>
    <script>
        let wsClient = null;
        let currentUserId = 'nurse001'; // 可以从登录获取
        let currentAlertFilter = 'all';
        let currentAlertId = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPatients();
            await loadAlerts();
            setupWebSocket();
            
            // 定期刷新
            setInterval(loadPatients, 60000); // 1分钟刷新患者
            setInterval(loadAlerts, 30000); // 30秒刷新告警
        });
        
        // 加载患者列表
        async function loadPatients() {
            try {
                const patients = await apiMethods.getPatients(null, true);
                displayPatients(patients);
            } catch (error) {
                console.error('加载患者失败:', error);
            }
        }
        
        // 显示患者列表
        async function displayPatients(patients) {
            const grid = document.getElementById('patientsGrid');
            
            if (patients.length === 0) {
                grid.innerHTML = '<div class="empty-state">暂无患者</div>';
                return;
            }
            
            let html = '';
            for (const patient of patients) {
                const status = await apiMethods.getLiveStatus(patient.patient_id);
                const pendingAlerts = status.pending_alerts || [];
                const latestAnalysis = status.latest_analysis;
                
                let overallStatus = 'normal';
                if (latestAnalysis && latestAnalysis.analysis_data) {
                    const analysis = typeof latestAnalysis.analysis_data === 'string'
                        ? JSON.parse(latestAnalysis.analysis_data)
                        : latestAnalysis.analysis_data;
                    overallStatus = analysis.overall_status || 'normal';
                }
                
                // 翻译状态值
                const statusMap = {
                    'normal': '正常',
                    'attention': '注意',
                    'critical': '紧急',
                    '正常': '正常',
                    '注意': '注意',
                    '紧急': '紧急'
                };
                const translatedStatus = statusMap[overallStatus] || statusMap[overallStatus.toLowerCase()] || overallStatus;
                
                const cardClass = (overallStatus === 'critical' || overallStatus === '紧急') ? 'critical' 
                    : (overallStatus === 'attention' || overallStatus === '注意') ? 'high' : '';
                
                html += `
                    <div class="patient-card ${cardClass}">
                        <div class="patient-header">
                            <div>
                                <div class="patient-name">${patient.full_name}</div>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                                    ${patient.patient_code} | ${patient.bed_number || ''}
                                </div>
                            </div>
                            ${pendingAlerts.length > 0 ? `
                                <div class="alert-count">${pendingAlerts.length}</div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 12px;">
                            <div style="font-size: 14px; color: #cbd5e1;">
                                风险等级: <span class="status-badge ${patient.risk_level}">${translateRiskLevel(patient.risk_level)}</span>
                            </div>
                            <div style="font-size: 14px; color: #cbd5e1; margin-top: 8px;">
                                状态: <span class="status-badge ${overallStatus}">${overallStatus}</span>
                            </div>
                            ${latestAnalysis ? `
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                                    最新检测: ${new Date(latestAnalysis.timestamp).toLocaleString()}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        // 加载告警列表
        async function loadAlerts() {
            try {
                let status = null;
                let severity = null;
                
                // 根据过滤器设置状态和严重程度
                if (currentAlertFilter === 'pending') {
                    status = 'pending';
                } else if (currentAlertFilter === 'critical') {
                    severity = 'critical';
                } else if (currentAlertFilter === 'high') {
                    severity = 'high';
                }
                // 'all' 时 status 和 severity 都为 null，显示所有告警
                
                const alerts = await apiMethods.getAlerts(null, status, severity, 50);
                // 过滤掉已处理的告警（除非是查看全部）
                const filteredAlerts = currentAlertFilter === 'all' 
                    ? alerts 
                    : alerts.filter(alert => alert.status !== 'resolved' && alert.status !== '已处理');
                displayAlerts(filteredAlerts);
            } catch (error) {
                console.error('加载告警失败:', error);
            }
        }
        
        // 翻译风险等级
        function translateRiskLevel(riskLevel) {
            const riskMap = {
                'high': '高',
                'medium': '中',
                'low': '低',
                '高': '高',
                '中': '中',
                '低': '低'
            };
            return riskMap[riskLevel] || riskMap[riskLevel.toLowerCase()] || riskLevel;
        }
        
        // 翻译告警状态
        function translateAlertStatus(status) {
            const statusMap = {
                'pending': '待处理',
                'acknowledged': '已确认',
                'resolved': '已处理',
                'false_alarm': '误报',
                '待处理': '待处理',
                '已确认': '已确认',
                '已处理': '已处理',
                '误报': '误报'
            };
            return statusMap[status] || statusMap[status.toLowerCase()] || status;
        }
        
        // 翻译告警描述
        function translateAlertText(text) {
            if (!text) return '';
            // 如果已经是中文，直接返回
            if (/[\u4e00-\u9fa5]/.test(text)) {
                return text;
            }
            
            let translated = text;
            // 常见英文短语翻译
            translated = translated.replace(/Patient is on the floor/gi, '患者在地面上');
            translated = translated.replace(/near the nurse station/gi, '靠近护士站');
            translated = translated.replace(/indicating a fall/gi, '表明跌倒');
            translated = translated.replace(/Possible head trauma/gi, '可能头部受伤');
            translated = translated.replace(/lying motionless/gi, '躺着一动不动');
            translated = translated.replace(/on the floor/gi, '在地面上');
            translated = translated.replace(/Patient is lying/gi, '患者躺着');
            translated = translated.replace(/motionless/gi, '一动不动');
            translated = translated.replace(/head trauma/gi, '头部受伤');
            translated = translated.replace(/fall detected/gi, '检测到跌倒');
            
            return translated;
        }
        
        // 显示告警列表
        function displayAlerts(alerts) {
            const listDiv = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">暂无告警</div>';
                return;
            }
            
            let html = '';
            alerts.forEach(alert => {
                const time = new Date(alert.created_at).toLocaleString('zh-CN');
                const translatedTitle = translateAlertText(alert.title);
                const translatedDesc = translateAlertText(alert.description);
                const translatedStatus = translateAlertStatus(alert.status);
                
                html += `
                    <div class="alert-item ${alert.severity}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${translatedTitle}</div>
                                <div style="font-size: 14px; color: #cbd5e1;">${translatedDesc}</div>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                                    ${time} | 患者: ${alert.patient_id.substring(0, 8)}... | 状态: ${translatedStatus}
                                </div>
                            </div>
                        </div>
                        ${alert.status === 'pending' || alert.status === '待处理' ? `
                            <div class="alert-actions">
                                <button class="btn btn-primary btn-sm" onclick="openAlertModal('${alert.alert_id}')">
                                    处理
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        // 过滤告警
        function filterAlerts(filter) {
            currentAlertFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadAlerts();
        }
        
        // 打开告警处理模态框
        async function openAlertModal(alertId) {
            currentAlertId = alertId;
            try {
                const response = await api.get(`/api/alerts/${alertId}`);
                const alert = await response.json();
                const modalContent = document.getElementById('alertModalContent');
                
                const translatedTitle = translateAlertText(alert.title);
                const translatedDesc = translateAlertText(alert.description);
                const translatedStatus = translateAlertStatus(alert.status);
                const alertTime = new Date(alert.created_at).toLocaleString('zh-CN');
                
                modalContent.innerHTML = `
                    <div>
                        <div style="margin-bottom: 12px;">
                            <strong>告警标题:</strong> ${translatedTitle}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>告警描述:</strong> ${translatedDesc}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>状态:</strong> ${translatedStatus}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>时间:</strong> ${alertTime}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>严重程度:</strong> ${alert.severity === 'critical' ? '紧急' : alert.severity === 'high' ? '高' : alert.severity === 'medium' ? '中' : '低'}
                        </div>
                    </div>
                        <div class="form-group">
                            <label class="form-label">处理备注</label>
                            <textarea id="resolutionNotes" class="form-input" rows="3" 
                                placeholder="请输入处理备注..."></textarea>
                        </div>
                    </div>
                `;
                document.getElementById('alertModal').classList.add('active');
            } catch (error) {
                console.error('加载告警详情失败:', error);
            }
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('alertModal').classList.remove('active');
            currentAlertId = null;
        }
        
        // 确认告警
        async function acknowledgeAlert() {
            if (!currentAlertId) return;
            
            try {
                await apiMethods.acknowledgeAlert(currentAlertId, currentUserId);
                closeModal();
                loadAlerts();
                showSuccess('告警已确认');
            } catch (error) {
                showError('确认失败: ' + error.message);
            }
        }
        
        // 处理告警
        async function resolveAlert() {
            if (!currentAlertId) return;
            
            const notes = document.getElementById('resolutionNotes').value;
            if (!notes.trim()) {
                showError('请输入处理备注');
                return;
            }
            
            try {
                await apiMethods.resolveAlert(currentAlertId, currentUserId, notes);
                closeModal();
                loadAlerts();
                loadPatients(); // 刷新患者列表
                showSuccess('告警已处理');
            } catch (error) {
                showError('处理失败: ' + error.message);
            }
        }
        
        // 设置WebSocket
        function setupWebSocket() {
            wsClient = new WebSocketClient(currentUserId);
            
            wsClient.on('connected', () => {
                updateWSStatus(true);
            });
            
            wsClient.on('disconnected', () => {
                updateWSStatus(false);
            });
            
            wsClient.on('alert', (message) => {
                showNewAlert(message);
                loadAlerts();
                loadPatients();
            });
            
            wsClient.connect();
        }
        
        function updateWSStatus(connected) {
            const indicator = document.getElementById('wsStatus');
            const text = document.getElementById('wsStatusText');
            
            if (connected) {
                indicator.className = 'status-indicator normal';
                text.textContent = '已连接';
            } else {
                indicator.className = 'status-indicator';
                text.textContent = '未连接';
            }
        }
        
        function showNewAlert(message) {
            // 显示通知
            if (Notification.permission === 'granted') {
                new Notification('新告警', {
                    body: message.message,
                    icon: '/static/icon.png'
                });
            }
            
            // 自动刷新
            loadAlerts();
            loadPatients();
        }
        
        function refreshPatients() {
            loadPatients();
            showSuccess('已刷新');
        }
        
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 3000);
        }
        
        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 5000);
        }
        
        // 请求通知权限
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>

